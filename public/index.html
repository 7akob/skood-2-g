<!DOCTYPE html>
<html>

<head>
  <title>Watch Together</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="https://www.youtube.com/iframe_api"></script>
</head>

<body>
  <h1>YouTube Watch Together</h1>

  <input id="videoInput" placeholder="YouTube link">
  <button onclick="loadVideo()">Load video</button>

  <div id="player"></div>

  <h3>Chat</h3>
  <div id="chatBox" style="border:1px solid #ccc; width:300px; height:200px; overflow-y:auto; padding:5px;"></div>
  <input id="chatInput" placeholder="Type a message" />
  <button onclick="sendMessage()">Send</button>

  <script>
    const socket = io();
    let player;

    // Load IFrame API
    function onYouTubeIframeAPIReady() {
      player = new YT.Player("player", {
        height: "360",
        width: "640",
        playerVars: {
          autoplay: 0,
          controls: 1,
          origin: window.location.origin,
          enablejsapi: 1,
          modestbranding: 1
        },
        videoId: "",
        events: { onStateChange: handleStateChange }
      });

    }

    function extractVideoId(url) {
      const match = url.match(/v=([^&]+)/);
      return match ? match[1] : url;
    }

    function loadVideo() {
      const link = document.getElementById("videoInput").value;
      const id = extractVideoId(link);
      socket.emit("change_video", id);
      player.loadVideoById(id);
    }

    // Send events
    function handleStateChange(event) {
      const time = player.getCurrentTime();

      if (event.data === YT.PlayerState.PLAYING) {
        socket.emit("play", time);
      }
      if (event.data === YT.PlayerState.PAUSED) {
        socket.emit("pause", time);
      }
    }

    // Receive events
    socket.on("change_video", (id) => player.loadVideoById(id));
    socket.on("play", (t) => { player.seekTo(t, true); player.playVideo(); });
    socket.on("pause", (t) => { player.seekTo(t, true); player.pauseVideo(); });
    socket.on("seek", (t) => player.seekTo(t, true));

    socket.on("sync_state", (state) => {
      if (state.videoId) player.loadVideoById(state.videoId);
      player.seekTo(state.time || 0);
      if (state.isPlaying) player.playVideo();
    });


    // Chat sending function
    function sendMessage() {
      const input = document.getElementById("chatInput");
      if (input.value.trim() === "") return;
      socket.emit("chat_message", input.value);
      input.value = "";
    }

    // Receive message
    socket.on("chat_message", (msg) => {
      const box = document.getElementById("chatBox");
      const el = document.createElement("div");
      el.textContent = msg;
      box.appendChild(el);
      box.scrollTop = box.scrollHeight;
    });

  </script>

</body>

</html>