<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Skåda på tv</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="https://www.youtube.com/iframe_api"></script>

  <style>
    body { font-family: sans-serif; max-width: 800px; margin: 20px auto; }
    #chatBox { border: 1px solid #ccc; height: 200px; overflow-y: auto; padding: 5px; }
body {
  background: #000080;
  font-family: "Comic Sans MS", "Tahoma", sans-serif;
  color: #00FFEA;
  text-align: center;
  padding: 20px;
}

  h1 {
    color: #FFFF00;
    text-shadow: 2px 2px #FF00FF;
    font-size: 40px;
    margin-bottom: 10px;
  }

  h2 {
    color: #00FF00;
    text-shadow: 1px 1px black;
  }

  input, button {
    font-family: "Comic Sans MS", Arial;
    font-size: 16px;
    padding: 8px;
    border: 3px solid #FF00FF;
    background: linear-gradient(90deg, #00FFFF, #FF00FF);
    color: black;
    margin: 5px;
    border-radius: 5px;
    box-shadow: 2px 2px 4px black;
  }

  button:hover {
    background: linear-gradient(90deg, #FFFF00, #00FF00);
    cursor: pointer;
  }

  #player {
    border: 5px double #FFFF00;
    box-shadow: 0 0 20px #FF00FF;
    margin-top: 15px;
  }

  #chatBox {
    border: 4px ridge #00FFFF;
    background: rgba(0, 0, 0, 0.5);
    width: 350px;
    height: 250px;
    margin: 0 auto;
    color: #00FFEA;
    overflow-y: auto;
    padding: 10px;
    font-size: 14px;
    box-shadow: inset 0 0 10px #00FFFF;
  }

  #chatInput {
    width: 250px;
    background: #FFFFCC;
    color: black;
  }

  .message {
    border-bottom: 1px dotted #00FFFF;
    padding: 4px;
  }

  .retro-divider {
    margin: 20px auto;
    width: 90%;
    height: 5px;
    background: repeating-linear-gradient(
      45deg,
      #FF00FF,
      #FF00FF 10px,
      #00FFFF 10px,
      #00FFFF 20px
    );
    box-shadow: 0 0 10px #00FFFF;
  }
  .message {
  padding: 4px;
  margin: 2px 0;
  border-bottom: 1px dotted #00FFFF;
  font-family: "Comic Sans MS", Tahoma, sans-serif;
  text-align: left;
}

  </style>
</head>
<body>

<h1>Skåda Youtube socket</h1>

<input id="videoInput" placeholder="Paste YouTube link or video ID">
<button onclick="loadVideo()">Load Video</button>

<div id="player" style="margin-top: 10px;"></div>

<h2>Chat</h2>
<div id="chatBox"></div>
<input id="chatInput" placeholder="Type a message">
<button onclick="sendMessage()">Send</button>

<script>
let socket;
let player;
let suppressEvents = false; 
let lastState = null;

// Generate a random username
const username = "User" + Math.floor(Math.random() * 999);


// -------------------- SOCKET --------------------------

socket = io({
  transports: ["websocket"]
});

socket.on("sync_state", (s) => {
  if (!player) {
    pendingSync = s;
  } else {
    applySync(s);
  }
});

socket.on("change_video", (id) => {
  suppressEvents = true;
  player.loadVideoById(id);
  player.seekTo(0, true);
  resetSuppress();
});

socket.on("play", (t) => {
  suppressEvents = true;
  player.seekTo(t, true);
  player.playVideo();
  lastState = YT.PlayerState.PLAYING;
  resetSuppress();
});

socket.on("pause", (t) => {
  suppressEvents = true;
  player.seekTo(t, true);
  player.pauseVideo();
  lastState = YT.PlayerState.PAUSED;
  resetSuppress();
});

socket.on("seek", (t) => {
  suppressEvents = true;
  player.seekTo(t, true);
  resetSuppress();
});

// -------------------- YOUTUBE --------------------------

let pendingSync = null;

function onYouTubeIframeAPIReady() {
  player = new YT.Player("player", {
    height: "360",
    width: "640",
    videoId: "",
    playerVars: {
      autoplay: 0,
      controls: 1,
      origin: window.location.origin,
      enablejsapi: 1,
      modestbranding: 1
    },
    events: { onStateChange }
  });

  if (pendingSync) {
    applySync(pendingSync);
    pendingSync = null;
  }
}

function applySync(state) {
  if (!player) return;

  suppressEvents = true;
  player.loadVideoById(state.videoId);
  player.seekTo(state.time, true);

  if (state.isPlaying) {
    player.playVideo();
    lastState = YT.PlayerState.PLAYING;
  } else {
    player.pauseVideo();
    lastState = YT.PlayerState.PAUSED;
  }

  resetSuppress();
}

function loadVideo() {
  const input = document.getElementById("videoInput").value.trim();
  if (!input) return;

  const id = extractId(input);
  socket.emit("change_video", id);

  suppressEvents = true;
  player.loadVideoById(id);
  player.seekTo(0);
  lastState = null;
  resetSuppress();
}

function extractId(str) {
  const m1 = str.match(/v=([^&]+)/);
  if (m1) return m1[1];
  const m2 = str.match(/youtu\.be\/([^?]+)/);
  if (m2) return m2[1];
  return str;
}

function onStateChange(event) {
  if (suppressEvents) return;

  const state = event.data;
  if (state !== YT.PlayerState.PLAYING && state !== YT.PlayerState.PAUSED) return;

  if (state === lastState) return;
  lastState = state;

  const t = player.getCurrentTime();

  if (state === YT.PlayerState.PLAYING) socket.emit("play", t);
  if (state === YT.PlayerState.PAUSED) socket.emit("pause", t);
}

function resetSuppress() {
  setTimeout(() => suppressEvents = false, 300);
}

// ------------------- CHAT ---------------------

function sendMessage() {
  const input = document.getElementById("chatInput");
  const msg = input.value.trim();
  if (!msg) return;

  socket.emit("chat_message", { user: username, text: msg });

  input.value = "";
}



socket.on("chat_message", (msg) => {
  const box = document.getElementById("chatBox");

  // 90s style timestamp
  const time = new Date().toLocaleTimeString();

  const el = document.createElement("div");
  el.className = "message";
  el.innerHTML = `
    <span style="color:#FFFF00;">[${time}]</span>
    <span style="color:#00FFEA;"><b>Friend:</b></span>
    <span style="color:#FFFFFF;">${msg}</span>
  `;

  box.appendChild(el);
  box.scrollTop = box.scrollHeight;
});

</script>

</body>
</html>
